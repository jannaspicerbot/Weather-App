name: Platform-Specific Builds

# =============================================================================
# TRIGGER STRATEGY:
# - Full installer builds ONLY on pushes to main (after PR merge)
# - Path filters ensure we skip builds for docs-only or test-only changes
# - PRs do NOT trigger installer builds (use main-ci.yml for PR validation)
# =============================================================================
on:
  push:
    branches: [main]
    paths:
      - 'weather_app/**'
      - 'installer/**'
      - 'web/src/**'
      - 'web/package.json'
      - 'web/vite.config.ts'
      - 'requirements.txt'
      - 'setup.py'
      - 'pyproject.toml'
      - '.github/workflows/platform-builds.yml'
  # Manual trigger for testing builds without merging to main
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'both'
        type: choice
        options:
          - windows
          - macos
          - both

# Cancel in-progress runs for the same branch (but not for workflow_dispatch)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'workflow_dispatch' }}

jobs:
  # ============================================================================
  # WINDOWS INSTALLER BUILD
  # Only runs platform-specific tests and installer generation
  # Relies on main-ci.yml for core testing
  # ============================================================================
  windows-installer:
    name: Windows Installer Build
    runs-on: windows-latest
    # Skip if workflow_dispatch specifies macos only
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.build_type != 'macos'

    steps:
      # -----------------------------------------------------------------------
      # CHECKOUT CODE
      # -----------------------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # SETUP PYTHON
      # -----------------------------------------------------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      # -----------------------------------------------------------------------
      # WINDOWS-SPECIFIC VALIDATIONS
      # -----------------------------------------------------------------------
      - name: Test Windows Console Encoding
        run: |
          python -c "import sys; print(f'Console encoding: {sys.stdout.encoding}')"
          Write-Host "Testing emoji support: ‚úÖ üìä üå°Ô∏è üíß" -ForegroundColor Cyan

      - name: Verify Windows Path Handling
        run: |
          python -c "import os; print(f'Temp directory: {os.environ.get(\"TEMP\")}')"
          python -c "from pathlib import Path; print(f'Current directory: {Path.cwd()}')"

      - name: Test Windows Tray Icon Compatibility
        run: |
          python -c "from PIL import Image; print('PIL/Pillow available for tray icons')"
          python -c "import pystray; print('pystray available for Windows tray')"

      # -----------------------------------------------------------------------
      # WINDOWS SYSTEM INFORMATION
      # -----------------------------------------------------------------------
      - name: Display Windows System Information
        run: |
          Write-Host "ü™ü Windows System Information:" -ForegroundColor Cyan
          systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
          Write-Host ""
          Write-Host "Python Version:" -ForegroundColor Yellow
          python --version
          Write-Host ""
          Write-Host "PowerShell Version:" -ForegroundColor Yellow
          $PSVersionTable.PSVersion

      # -----------------------------------------------------------------------
      # WINDOWS INSTALLER BUILD (PyInstaller)
      # -----------------------------------------------------------------------
      - name: Test PyInstaller Compatibility
        run: |
          pip install pyinstaller
          Write-Host "PyInstaller installed successfully" -ForegroundColor Green
          pyinstaller --version

      - name: Verify PyInstaller Spec Files
        run: |
          if (Test-Path "installer/windows/weather_app.spec") {
            Write-Host "‚úÖ Production spec file found" -ForegroundColor Green
          }
          if (Test-Path "installer/windows/weather_app_debug.spec") {
            Write-Host "‚úÖ Debug spec file found" -ForegroundColor Green
          }

      # -----------------------------------------------------------------------
      # BUILD FRONTEND FOR EMBEDDING
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Build Frontend for Embedding
        working-directory: web
        run: |
          npm ci
          npm run build
          Write-Host "‚úÖ Frontend built for embedding in Windows installer" -ForegroundColor Green
          if (Test-Path "dist/index.html") {
            Write-Host "‚úÖ Frontend dist/index.html verified" -ForegroundColor Green
          } else {
            Write-Host "‚ùå Frontend build failed - dist/index.html not found" -ForegroundColor Red
            exit 1
          }

      - name: Build Windows Installer (Production)
        working-directory: installer/windows
        run: |
          Write-Host "Building Windows installer (PRODUCTION)..." -ForegroundColor Cyan
          pyinstaller weather_app.spec --clean
          if (Test-Path "dist/WeatherApp/WeatherApp.exe") {
            Write-Host "‚úÖ Production executable created successfully" -ForegroundColor Green
            Get-Item "dist/WeatherApp/WeatherApp.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Host "‚ùå Production executable not found" -ForegroundColor Red
            exit 1
          }

      - name: Build Windows Installer (Debug)
        working-directory: installer/windows
        run: |
          Write-Host "Building Windows installer (DEBUG)..." -ForegroundColor Cyan
          pyinstaller weather_app_debug.spec --clean
          if (Test-Path "dist/WeatherApp_Debug/WeatherApp_Debug.exe") {
            Write-Host "‚úÖ Debug executable created successfully" -ForegroundColor Green
            Get-Item "dist/WeatherApp_Debug/WeatherApp_Debug.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Host "‚ùå Debug executable not found" -ForegroundColor Red
            exit 1
          }

      # -----------------------------------------------------------------------
      # SAVE BUILD ARTIFACTS
      # -----------------------------------------------------------------------
      - name: Upload Windows Production Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-${{ github.sha }}
          path: installer/windows/dist/WeatherApp/
          retention-days: 30

      - name: Upload Windows Debug Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-debug-${{ github.sha }}
          path: installer/windows/dist/WeatherApp_Debug/
          retention-days: 14

  # ============================================================================
  # MACOS APP BUNDLE BUILD
  # Only runs platform-specific tests and app bundle generation
  # Relies on main-ci.yml for core testing
  # ============================================================================
  macos-app:
    name: macOS App Bundle Build
    runs-on: macos-latest
    # Skip if workflow_dispatch specifies windows only
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.build_type != 'windows'

    steps:
      # -----------------------------------------------------------------------
      # CHECKOUT CODE
      # -----------------------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # SETUP PYTHON
      # -----------------------------------------------------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      # -----------------------------------------------------------------------
      # MACOS-SPECIFIC VALIDATIONS
      # -----------------------------------------------------------------------
      - name: Verify macOS System Information
        run: |
          echo "üçé macOS System Information:"
          sw_vers
          echo ""
          echo "Python Version:"
          python --version
          echo ""
          echo "Architecture:"
          uname -m

      - name: Test macOS File System Compatibility
        run: |
          python -c "import os; print(f'Home directory: {os.path.expanduser(\"~\")}')"
          python -c "from pathlib import Path; print(f'Current directory: {Path.cwd()}')"

      # -----------------------------------------------------------------------
      # SETUP NODE.JS FOR FRONTEND BUILD
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      # -----------------------------------------------------------------------
      # MACOS APP BUNDLE BUILD (PyInstaller)
      # -----------------------------------------------------------------------
      - name: Install PyInstaller
        run: |
          pip install pyinstaller
          echo "PyInstaller installed successfully"
          pyinstaller --version

      - name: Verify PyInstaller Spec Files
        run: |
          if [ -f "installer/macos/weather_app.spec" ]; then
            echo "‚úÖ macOS production spec file found"
          else
            echo "‚ùå macOS production spec file not found"
            exit 1
          fi
          if [ -f "installer/macos/weather_app_debug.spec" ]; then
            echo "‚úÖ macOS debug spec file found"
          else
            echo "‚ùå macOS debug spec file not found"
            exit 1
          fi

      - name: Build Frontend for Embedding
        working-directory: web
        run: |
          npm ci
          npm run build
          echo "‚úÖ Frontend built for embedding in app bundle"
          if [ -f "dist/index.html" ]; then
            echo "‚úÖ Frontend dist/index.html verified"
          else
            echo "‚ùå Frontend build failed - dist/index.html not found"
            exit 1
          fi

      - name: Generate macOS Icon (.icns)
        run: |
          echo "üé® Generating macOS icon file..."
          ICONSET_PATH="weather_app/resources/icons/icon.iconset"
          ICNS_PATH="weather_app/resources/icons/weather-app.icns"
          if [ -d "$ICONSET_PATH" ]; then
            iconutil -c icns "$ICONSET_PATH" -o "$ICNS_PATH"
            echo "‚úÖ Generated $ICNS_PATH"
            ls -la "$ICNS_PATH"
          else
            echo "‚ùå Iconset not found at $ICONSET_PATH"
            exit 1
          fi

      - name: Build macOS App Bundle (Production)
        working-directory: installer/macos
        run: |
          echo "üçé Building macOS app bundle (PRODUCTION)..."
          pyinstaller weather_app.spec --clean
          if [ -d "dist/WeatherApp.app" ]; then
            echo "‚úÖ macOS production app bundle created successfully"
            ls -la dist/
          else
            echo "‚ùå Production app bundle not found"
            exit 1
          fi

      - name: Build macOS App Bundle (Debug)
        working-directory: installer/macos
        run: |
          echo "üçé Building macOS app bundle (DEBUG)..."
          pyinstaller weather_app_debug.spec --clean
          if [ -d "dist/WeatherApp_Debug.app" ]; then
            echo "‚úÖ macOS debug app bundle created successfully"
            ls -la dist/
          else
            echo "‚ùå Debug app bundle not found"
            exit 1
          fi

      # -----------------------------------------------------------------------
      # SAVE BUILD ARTIFACTS
      # -----------------------------------------------------------------------
      - name: Upload macOS Production App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-bundle-${{ github.sha }}
          path: installer/macos/dist/WeatherApp.app
          retention-days: 30

      - name: Upload macOS Debug App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-bundle-debug-${{ github.sha }}
          path: installer/macos/dist/WeatherApp_Debug.app
          retention-days: 14
