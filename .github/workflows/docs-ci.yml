name: Documentation CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.claude/**'
      - '.github/workflows/docs-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.claude/**'
      - '.github/workflows/docs-ci.yml'

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Run markdownlint
      uses: articulate/actions-markdownlint@v1
      with:
        config: .markdownlint.json
        files: '**/*.md'
        ignore: node_modules
      continue-on-error: true

  link-check:
    name: Check Broken Links
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check links in markdown files
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.markdown-link-check.json'
      continue-on-error: true

  adr-validation:
    name: Validate ADR Format
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check ADR file naming convention
      run: |
        # Check that ADR files follow NNN-name.md pattern
        for file in docs/architecture/decisions/*.md; do
          filename=$(basename "$file")
          if [[ ! "$filename" =~ ^[0-9]{3}- ]]; then
            echo "ERROR: $filename does not follow ADR naming convention (NNN-name.md)"
            exit 1
          fi
        done

    - name: Check ADR required sections
      run: |
        # Check that ADRs have required sections
        required_sections=("Status" "Date" "Context" "Decision" "Consequences")
        for file in docs/architecture/decisions/*.md; do
          echo "Checking $file..."
          for section in "${required_sections[@]}"; do
            if ! grep -q "## $section" "$file"; then
              echo "WARNING: $file missing required section: ## $section"
            fi
          done
        done

  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Run spell checker
      uses: rojopolis/spellcheck-github-actions@0.37.0
      with:
        config_path: .spellcheck.yml
        task_name: Markdown
      continue-on-error: true

  doc-structure:
    name: Validate Documentation Structure
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check required documentation files exist
      run: |
        required_files=(
          "docs/README.md"
          "docs/product/requirements.md"
          "docs/architecture/overview.md"
          "docs/design/inclusive-design.md"
          "docs/technical/api-reference.md"
          "docs/technical/cli-reference.md"
          "docs/technical/database-schema.md"
          "docs/technical/deployment-guide.md"
          "README.md"
          ".claude/CLAUDE.md"
        )

        missing=()
        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            missing+=("$file")
          fi
        done

        if [ ${#missing[@]} -gt 0 ]; then
          echo "ERROR: Missing required documentation files:"
          printf '%s\n' "${missing[@]}"
          exit 1
        else
          echo "✅ All required documentation files present"
        fi

    - name: Check ADR sequence numbers
      run: |
        # Check that ADR numbers are sequential
        adrs=(docs/architecture/decisions/[0-9][0-9][0-9]-*.md)
        if [ ${#adrs[@]} -eq 0 ]; then
          echo "No ADRs found"
          exit 0
        fi

        expected=1
        for file in "${adrs[@]}"; do
          number=$(basename "$file" | cut -d- -f1 | sed 's/^0*//')
          if [ "$number" != "$expected" ]; then
            echo "WARNING: ADR sequence gap or duplicate. Expected $expected, found $number in $file"
          fi
          expected=$((number + 1))
        done
        echo "✅ ADR sequence validated"

  accessibility-docs-check:
    name: Verify Accessibility Standards Documentation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check inclusive design documentation completeness
      run: |
        required_terms=(
          "WCAG 2.2"
          "Level AA"
          "POUR"
          "Screen reader"
          "Keyboard navigation"
          "Color contrast"
          "ARIA"
        )

        file="docs/design/inclusive-design.md"
        if [[ ! -f "$file" ]]; then
          echo "ERROR: Inclusive design documentation missing!"
          exit 1
        fi

        missing=()
        for term in "${required_terms[@]}"; do
          if ! grep -qi "$term" "$file"; then
            missing+=("$term")
          fi
        done

        if [ ${#missing[@]} -gt 0 ]; then
          echo "WARNING: Inclusive design docs missing terms:"
          printf '%s\n' "${missing[@]}"
        else
          echo "✅ Inclusive design documentation complete"
        fi
