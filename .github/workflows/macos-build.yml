name: macOS Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-macos:
    name: macOS Native Build & Test
    # This spins up a real Mac instance to verify compatibility
    runs-on: macos-latest

    steps:
      # -----------------------------------------------------------------------
      # CHECKOUT CODE
      # -----------------------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # SETUP PYTHON BACKEND (FastAPI + DuckDB)
      # -----------------------------------------------------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Speeds up future runs

      - name: Install Backend Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio
          pip install -r requirements.txt
          pip install -e .

      - name: Verify Backend Logic
        run: |
          # Runs your Pydantic and DuckDB logic tests
          pytest tests/ -v -m "not requires_api_key" --cov=weather_app --cov-report=term
          echo "‚úÖ Backend tests passed on macOS"

      - name: Validate DuckDB on macOS
        run: |
          python -c "import duckdb; print(f'‚úÖ DuckDB {duckdb.__version__} working on macOS')"

      - name: Validate FastAPI on macOS
        run: |
          python -c "from weather_app.web.app import create_app; app = create_app(); print('‚úÖ FastAPI app initialized on macOS')"

      # -----------------------------------------------------------------------
      # SETUP FRONTEND (React + Vite)
      # -----------------------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: web
        run: npm ci

      - name: Build React Frontend
        working-directory: web
        run: |
          npm run build # Verifies TypeScript safety and Vite bundling
          echo "‚úÖ Frontend build successful on macOS"

      - name: Check Frontend Bundle Size
        working-directory: web
        run: |
          echo "üì¶ macOS Frontend Bundle Size:"
          du -sh dist/

      # -----------------------------------------------------------------------
      # MACOS-SPECIFIC VALIDATIONS
      # -----------------------------------------------------------------------
      - name: Verify macOS System Information
        run: |
          echo "üçé macOS System Information:"
          sw_vers
          echo ""
          echo "Python Version:"
          python --version
          echo ""
          echo "Node.js Version:"
          node --version
          echo ""
          echo "Architecture:"
          uname -m

      - name: Test macOS File System Compatibility
        run: |
          # Test macOS-specific path handling
          python -c "import os; print(f'‚úÖ Home directory: {os.path.expanduser(\"~\")}')"
          python -c "from pathlib import Path; print(f'‚úÖ Current directory: {Path.cwd()}')"

      # -----------------------------------------------------------------------
      # SAVE THE BUILD ARTIFACTS
      # -----------------------------------------------------------------------
      - name: Upload macOS Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-weather-app-dist
          path: |
            web/dist/
          retention-days: 7

      - name: Upload Backend Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-results
          path: |
            .coverage
            htmlcov/
          retention-days: 7

      # -----------------------------------------------------------------------
      # FUTURE: MACOS APP BUNDLE PREPARATION
      # -----------------------------------------------------------------------
      - name: Prepare macOS App Bundle (Future)
        if: false  # Disabled until Phase 3 deployment
        run: |
          echo "üöÄ Future: Build .app bundle for macOS distribution"
          echo "Will use py2app or similar tool"
