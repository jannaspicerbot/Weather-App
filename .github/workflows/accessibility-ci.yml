name: Accessibility CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'web/**'
      - '.github/workflows/accessibility-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'web/**'
      - '.github/workflows/accessibility-ci.yml'

jobs:
  # ============================================================================
  # ACCESSIBILITY LINTING - Static analysis with eslint-plugin-jsx-a11y
  # ============================================================================
  a11y-lint:
    name: Accessibility Linting
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run ESLint with Accessibility Rules
        run: npm run lint
        # eslint-plugin-jsx-a11y rules are configured in eslint.config.js

  # ============================================================================
  # COMPONENT ACCESSIBILITY TESTS - Vitest + axe-core
  # ============================================================================
  a11y-unit-tests:
    name: Component A11y Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run Accessibility Tests
        run: npm test

      - name: Run Tests with Coverage
        run: npm run test:coverage

  # ============================================================================
  # LIGHTHOUSE CI - Full page accessibility audit
  # ============================================================================
  lighthouse:
    name: Lighthouse Accessibility Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Build Production Bundle
        run: npm run build

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.14.x

      - name: Run Lighthouse CI
        run: |
          lhci autorun \
            --collect.staticDistDir=./dist \
            --collect.numberOfRuns=3 \
            --assert.preset=lighthouse:recommended \
            --assert.assertions.categories:accessibility=error \
            --assert.assertions.categories:accessibility.minScore=0.9 \
            --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 14

  # ============================================================================
  # SUMMARY JOB - Report overall status
  # ============================================================================
  a11y-summary:
    name: Accessibility Summary
    runs-on: ubuntu-latest
    needs: [a11y-lint, a11y-unit-tests, lighthouse]
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "## Accessibility CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.a11y-lint.result }}" == "success" ]; then
            echo "- :white_check_mark: **Linting**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :x: **Linting**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.a11y-unit-tests.result }}" == "success" ]; then
            echo "- :white_check_mark: **Component Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :x: **Component Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lighthouse.result }}" == "success" ]; then
            echo "- :white_check_mark: **Lighthouse Audit**: Passed (score >= 90)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :x: **Lighthouse Audit**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Target: WCAG 2.2 Level AA compliance" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any check failed
        if: |
          needs.a11y-lint.result != 'success' ||
          needs.a11y-unit-tests.result != 'success' ||
          needs.lighthouse.result != 'success'
        run: exit 1
